<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title> 拽 专砖 - Atara</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">

    <h1 class="text-2xl font-bold text-center mb-6"> 专   拽 砖 Atara</h1>

    <!-- 爪转 注转 Flash -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="mb-4 p-3 bg-yellow-200 text-yellow-800 rounded">
          <ul>
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endwith %}

    <!-- 爪转 拽爪/拽住 砖注 -->
    {% if uploaded_files_pending or raw_text_summaries_pending %}
      <div class="mb-4 p-4 bg-gray-100 rounded border max-h-40 overflow-y-auto">
        <h2 class="font-semibold mb-2">拽爪 拽住 转 注:</h2>
        <ul>
          {% for item in uploaded_files_pending %}
            {% set index = loop.index0 %}
            <li class="flex justify-between items-center mb-1">
              <span> 拽抓 砖注 (转 专砖)</span>
              <form method="POST" class="inline">
                <input type="hidden" name="remove_upload" value="true" />
                <input type="hidden" name="remove_index" value="{{ index }}" />
                <button type="submit" class="text-red-600 hover:text-red-800 font-bold px-2 py-1 rounded" title="住专">住专</button>
              </form>
            </li>
          {% endfor %}
          {% for item in raw_text_summaries_pending %}
            {% set index = loop.index0 + uploaded_files_pending|length %}
            <li class="flex justify-between items-center mb-1">
              <span> 拽住 驻砖 砖住</span>
              <form method="POST" class="inline">
                <input type="hidden" name="remove_upload" value="true" />
                <input type="hidden" name="remove_index" value="{{ index }}" />
                <button type="submit" class="text-red-600 hover:text-red-800 font-bold px-2 py-1 rounded" title="住专">住专</button>
              </form>
            </li>
          {% endfor %}
        </ul>
        <form method="POST" class="mt-3 text-center">
          <button type="submit" name="confirm_uploads" value="true" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">砖专 注转 注 专 注</button>
        </form>
      </div>
    {% endif %}

    <!-- 爪转 注转 爪' -->
    <div id="chat-box" class="space-y-4 max-h-[60vh] overflow-y-auto border p-4 rounded bg-gray-50 mb-6">
      {% if history %}
        {% for msg in history %}
          <div class="flex {% if msg.role == 'user' %}justify-end{% else %}justify-start{% endif %}">
            <div class="{% if msg.role == 'user' %}bg-blue-100{% else %}bg-green-100{% endif %} px-4 py-2 rounded-lg max-w-[80%]">
              {{ msg.content }}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-center text-gray-500"> 驻注 注转 砖 注 ...</p>
      {% endif %}
    </div>

    <!-- 砖 拽 注 -->
    <form method="POST" enctype="multipart/form-data" class="mt-6 flex gap-2 items-center">
      <input type="text" name="message" placeholder="转  转 转砖 砖..." class="flex-1 p-2 border rounded focus:outline-none focus:ring focus:border-blue-300" />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">砖</button>
    </form>

    <!-- 注转 拽爪 -->
    <form method="POST" enctype="multipart/form-data" class="mt-4 flex items-center gap-2">
      <input type="file" name="file" accept=".pdf,.docx,.txt" class="border rounded p-1" />
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">注 拽抓</button>
    </form>

    <!-- 转 砖 -->
    <form method="POST" class="mt-6 text-center">
      <button type="submit" name="reset" value="true" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">转 砖</button>
    </form>

  </div>

  <script>
    const chatBox = document.getElementById('chat-box');

    if (chatBox) {
      let userScrolled = false;

      chatBox.addEventListener('scroll', () => {
        const nearBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 50;
        userScrolled = !nearBottom;
      });

      function scrollToBottom() {
        if (!userScrolled) {
          chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }
      }

      window.addEventListener('load', () => {
        setTimeout(scrollToBottom, 100);
      });
    }
  </script>
</body>
</html>
